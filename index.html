<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality & Pollen Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #FFF176 0%, #66BB6A 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 0.9em;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-subtitle {
            font-size: 0.9em;
            color: #a0aec0;
            margin-top: 5px;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.3em;
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: 600;
        }

        canvas {
            max-height: 400px;
        }

        .location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .location-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .location-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 0.9em;
            color: #718096;
        }

        .metric-value {
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        /* AQI Colors */
        .aqi-good { background: #66BB6A; color: white; }
        .aqi-moderate { background: #FFF176; color: #333; }
        .aqi-unhealthy-sensitive { background: #FFB74D; color: white; }
        .aqi-unhealthy { background: #EF5350; color: white; }
        .aqi-very-unhealthy { background: #AB47BC; color: white; }
        .aqi-hazardous { background: #8D6E63; color: white; }

        /* Pollen Colors */
        .pollen-low { background: #C8E6C9; color: #333; }
        .pollen-medium { background: #FFF176; color: #333; }
        .pollen-high { background: #FFB74D; color: white; }
        .pollen-very-high { background: #EF5350; color: white; }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #718096;
            font-size: 1.1em;
        }

        .last-updated {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .accuracy-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .accuracy-good { background: #66BB6A; color: white; }
        .accuracy-fair { background: #FFB74D; color: white; }
        .accuracy-poor { background: #EF5350; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåç Air Quality & Pollen Tracker</h1>
            <p class="subtitle">Tracking health conditions and forecast accuracy across 11 US locations</p>
        </header>

        <div id="content">
            <div class="no-data">
                <h2>üìä Loading data...</h2>
                <p>If this is your first day, check back tomorrow!</p>
            </div>
        </div>

        <div class="last-updated" id="lastUpdated"></div>
    </div>

    <script>
        // Location names
        const LOCATION_NAMES = {
            'KBIS': 'Bismarck, ND',
            'KBOS': 'Boston, MA',
            'KDFW': 'Dallas/Fort Worth, TX',
            'KDEN': 'Denver, CO',
            'KLAX': 'Los Angeles, CA',
            'KMIA': 'Miami, FL',
            'KOMA': 'Omaha, NE',
            'KORD': 'Chicago, IL',
            'KPDX': 'Portland, OR',
            'KPHX': 'Phoenix, AZ',
            'KTUS': 'Tucson, AZ'
        };

        // Helper functions
        function getAQIClass(aqi) {
            if (aqi <= 50) return 'aqi-good';
            if (aqi <= 100) return 'aqi-moderate';
            if (aqi <= 150) return 'aqi-unhealthy-sensitive';
            if (aqi <= 200) return 'aqi-unhealthy';
            if (aqi <= 300) return 'aqi-very-unhealthy';
            return 'aqi-hazardous';
        }

        function getAQILabel(aqi) {
            if (aqi <= 50) return 'Good';
            if (aqi <= 100) return 'Moderate';
            if (aqi <= 150) return 'Unhealthy for Sensitive';
            if (aqi <= 200) return 'Unhealthy';
            if (aqi <= 300) return 'Very Unhealthy';
            return 'Hazardous';
        }

        function getPollenClass(level) {
            if (level <= 1) return 'pollen-low';
            if (level <= 2) return 'pollen-medium';
            if (level <= 3) return 'pollen-high';
            return 'pollen-very-high';
        }

        function getPollenLabel(level) {
            if (level <= 1) return 'Low';
            if (level <= 2) return 'Medium';
            if (level <= 3) return 'High';
            return 'Very High';
        }

        function getAccuracyClass(percentage) {
            if (percentage >= 80) return 'accuracy-good';
            if (percentage >= 60) return 'accuracy-fair';
            return 'accuracy-poor';
        }

        // Load and display data
        async function loadData() {
            try {
                // Load latest current conditions
                const aqFiles = await fetch('data/air_quality/current/')
                    .then(r => r.text())
                    .catch(() => null);
                
                const pollenFiles = await fetch('data/pollen/current/')
                    .then(r => r.text())
                    .catch(() => null);

                // Load results for accuracy stats
                const results = await fetch('data/results.json')
                    .then(r => r.json())
                    .catch(() => []);

                if (results.length === 0) {
                    return; // Show default "no data" message
                }

                // Get most recent date from results
                const dates = [...new Set(results.map(r => r.date))].sort();
                const latestDate = dates[dates.length - 1];

                // Load latest conditions
                const latestAQ = await fetch(`data/air_quality/current/${latestDate}.json`)
                    .then(r => r.json())
                    .catch(() => ({}));
                
                const latestPollen = await fetch(`data/pollen/current/${latestDate}.json`)
                    .then(r => r.json())
                    .catch(() => ({}));

                displayDashboard(latestAQ, latestPollen, results, latestDate);

            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function displayDashboard(aqData, pollenData, results, latestDate) {
            // Calculate statistics
            const aqResults = results.filter(r => r.type === 'air_quality');
            const pollenResults = results.filter(r => r.type === 'pollen');
            
            const aqAccuracy = aqResults.length > 0 
                ? Math.round((aqResults.filter(r => r.accurate).length / aqResults.length) * 100)
                : 0;
            
            const pollenAccuracy = pollenResults.length > 0
                ? Math.round((pollenResults.filter(r => r.accurate).length / pollenResults.length) * 100)
                : 0;

            // Find best/worst locations
            const locationAQIs = Object.entries(aqData).map(([code, data]) => ({
                code,
                aqi: data.aqi || 0
            })).sort((a, b) => a.aqi - b.aqi);

            const bestLocation = locationAQIs[0];
            const worstLocation = locationAQIs[locationAQIs.length - 1];

            // Build dashboard
            const html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Air Quality Accuracy</div>
                        <div class="stat-value">${aqAccuracy}%</div>
                        <div class="stat-subtitle">${aqResults.length} forecasts scored</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pollen Accuracy</div>
                        <div class="stat-value">${pollenAccuracy}%</div>
                        <div class="stat-subtitle">${pollenResults.length} forecasts scored</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Best Air Quality</div>
                        <div class="stat-value">${bestLocation.aqi}</div>
                        <div class="stat-subtitle">${LOCATION_NAMES[bestLocation.code]}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Worst Air Quality</div>
                        <div class="stat-value">${worstLocation.aqi}</div>
                        <div class="stat-subtitle">${LOCATION_NAMES[worstLocation.code]}</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">üìà Forecast Accuracy by Lead Time</div>
                    <canvas id="accuracyChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">üåç Current Conditions by Location</div>
                    <canvas id="locationChart"></canvas>
                </div>

                <div class="location-grid">
                    ${Object.keys(LOCATION_NAMES).map(code => `
                        <div class="location-card">
                            <div class="location-name">${LOCATION_NAMES[code]}</div>
                            <div class="metric-row">
                                <span class="metric-label">Air Quality</span>
                                <span class="metric-value ${getAQIClass(aqData[code]?.aqi || 0)}">
                                    ${aqData[code]?.aqi || 'N/A'} - ${getAQILabel(aqData[code]?.aqi || 0)}
                                </span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Pollen Level</span>
                                <span class="metric-value ${getPollenClass(pollenData[code]?.overall || 0)}">
                                    ${getPollenLabel(pollenData[code]?.overall || 0)}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('content').innerHTML = html;
            document.getElementById('lastUpdated').textContent = `Last updated: ${latestDate}`;

            // Create charts
            createAccuracyChart(results);
            createLocationChart(aqData, pollenData);
        }

        function createAccuracyChart(results) {
            const ctx = document.getElementById('accuracyChart');
            
            // Group by lead time and type
            const leadTimes = [1, 2, 3, 4, 5];
            const aqAccuracy = leadTimes.map(lead => {
                const subset = results.filter(r => r.type === 'air_quality' && r.lead_days === lead);
                return subset.length > 0 
                    ? (subset.filter(r => r.accurate).length / subset.length) * 100
                    : null;
            });

            const pollenAccuracy = leadTimes.map(lead => {
                const subset = results.filter(r => r.type === 'pollen' && r.lead_days === lead);
                return subset.length > 0
                    ? (subset.filter(r => r.accurate).length / subset.length) * 100
                    : null;
            });

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: leadTimes.map(d => `${d}-day`),
                    datasets: [
                        {
                            label: 'Air Quality Forecast',
                            data: aqAccuracy,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Pollen Forecast',
                            data: pollenAccuracy,
                            borderColor: '#66BB6A',
                            backgroundColor: 'rgba(102, 187, 106, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: value => value + '%'
                            }
                        }
                    }
                }
            });
        }

        function createLocationChart(aqData, pollenData) {
            const ctx = document.getElementById('locationChart');
            
            const locations = Object.keys(LOCATION_NAMES);
            const aqiValues = locations.map(code => aqData[code]?.aqi || 0);
            const pollenValues = locations.map(code => pollenData[code]?.overall || 0);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: locations.map(code => LOCATION_NAMES[code]),
                    datasets: [
                        {
                            label: 'Air Quality Index',
                            data: aqiValues,
                            backgroundColor: '#667eea',
                            borderColor: '#667eea',
                            borderWidth: 1
                        },
                        {
                            label: 'Pollen Level (√ó20)',
                            data: pollenValues.map(v => v * 20),
                            backgroundColor: '#66BB6A',
                            borderColor: '#66BB6A',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
